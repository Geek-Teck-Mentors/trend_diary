# テスト戦略

Status: Accepted

<!-- プルリクベースで開発するので、プルリクを作る段で Accepted の状態でOK -->
<!-- 別のADRによって置き換えられた場合 Replaced by #{ADR No.} に変更 -->
<!-- 明らかに不要になった場合 Deprecated に変更 -->

Relevant PR:

<!-- reference できるプルリクがあればそのリンクを貼ってください -->

# Context

モノレポアーキテクチャに基づいてプロジェクトを `domain`（ビジネスロジック）、`web`、`api` の3つの主要コンポーネントに分割する計画がある。これらのコンポーネントに対して効果的なテスト戦略を策定する必要がある。

`domain` レイヤー内部には、`model`、`service`、`repository` などのコンポーネントが含まれる。

## References

- https://github.com/Geek-Teck-Mentors/trend_diary/pull/150
- https://www.prisma.io/blog/testing-series-5-xWogenROXm#set-up-a-workflow

# Decision

モノレポ構成で `domain`、`web`、`api` の各レイヤーごとにテスト戦略を以下のように定義する：

1. **単体テスト（各レイヤー内）**

   - **domain**:
     - model（データモデル）
     - schema（スキーマ定義）
     - useCase（複雑なドメイン知識とロジックがある部分）
     - repository はテスト対象から除外（SQLのスナップショットテストになりがちで価値が低い）
   - **web**:
     - 共通コンポーネント
     - ページ（画面遷移を含まない操作のテスト）
     - API繋ぎ込み済みの単体ページ
   - **api**:
     - エンドポイント

2. **結合テスト（webのみ対象）**

   - 複数ページの結合テスト（画面遷移を含む操作のテスト）
   - APIを含んだ複数ページの結合テスト

3. **システムテスト（E2E）**
   - シナリオテスト（エンドユーザーに近い使い方を模したテスト）

## Reason

- **domain の一部テスト**：複雑なドメインロジックが含まれる model と useCase は十分にテストするべきだが、repository は ORM を使用しており SQL のスナップショットテストになりがちなため、テスト対象としては優先度を下げる。

- **web のテスト分割**：コンポーネントとページのテストを分け、さらに画面遷移を含むテストを結合テストとして区別することで、テストの範囲と目的を明確にする。

- **結合テストを web のみに限定**：画面遷移を含む操作や複数のコンポーネントの連携は web レイヤーで特に重要となるため。

# Consequences

- 各レイヤーの役割に合わせた適切なテストカバレッジが実現できる
- テスト実行の速度と信頼性のバランスが取れる
- 領域ごとに適切なテスト戦略を立てることで、無駄なテストコードの作成を避けられる
