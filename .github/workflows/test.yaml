name: Test

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/test.yaml'
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/test.yaml'
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'

# カバレッジの可視化で、コメントを残すための権限
permissions:
  contents: read
  pull-requests: write

# 連続push時に同じジョブが並列で実行されるのを防ぐ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# 共通の設定を定義
env:
  NODE_VERSION_FILE: .node-version

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      test_runner: ubuntu-latest
      run_frontend_test: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' || steps.check-test-config.outputs.diff-count != 0 || steps.check-frontend.outputs.diff-count != 0 }}
      run_domain_test: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' || steps.check-test-config.outputs.diff-count != 0 || steps.check-domain.outputs.diff-count != 0 }}
      run_api_test: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' || steps.check-test-config.outputs.diff-count != 0 || steps.check-api.outputs.diff-count != 0 }}
    steps:
      - uses: actions/checkout@v4

      - name: テスト設定ファイルの差分チェック
        id: check-test-config
        uses: ./.github/actions/diff
        with:
          subdir: '.github/workflows/test.yaml src/test/vitest-config/'

      - name: フロントエンドの差分チェック
        id: check-frontend
        uses: ./.github/actions/diff
        with:
          subdir: 'src/application/web src/application/web/components src/test/vitest-config/config.frontend.ts'
          exclude_pattern: 'src/application/web/components/shadcn'

      - name: ドメインの差分チェック
        id: check-domain
        uses: ./.github/actions/diff
        with:
          subdir: 'src/domain src/test/vitest-config/config.domain.ts'

      - name: APIの差分チェック
        id: check-api
        uses: ./.github/actions/diff
        with:
          subdir: 'src/application/api src/test/vitest-config/config.api.ts'

      - name: 差分結果の表示
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "メインブランチなので、リグレッションテストとして全て実行"
          else
            echo "テスト設定差分: ${{ steps.check-test-config.outputs.diff-count }} ファイル"
            echo "フロントエンド差分: ${{ steps.check-frontend.outputs.diff-count }} ファイル"
            echo "ドメイン差分: ${{ steps.check-domain.outputs.diff-count }} ファイル"
            echo "API差分: ${{ steps.check-api.outputs.diff-count }} ファイル"
            if [[ "${{ steps.check-test-config.outputs.diff-count }}" != "0" ]]; then
              echo "テスト設定ファイルに変更があるため、全テストを実行"
            fi
            echo "テストの準備完了"
          fi
        shell: bash

  frontend:
    needs: setup
    runs-on: ${{ needs.setup.outputs.test_runner }}
    if: ${{ needs.setup.outputs.run_frontend_test == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Node.jsの構築
        uses: ./.github/actions/setup_node
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}

      - name: フロントエンドのテスト
        uses: ./.github/actions/test_cov
        with:
          target: frontend

  domain:
    needs: setup
    runs-on: ${{ needs.setup.outputs.test_runner }}
    if: ${{ needs.setup.outputs.run_domain_test == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Node.jsの構築
        uses: ./.github/actions/setup_node
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}

      - name: ドメインのテスト
        uses: ./.github/actions/test_cov
        with:
          target: domain

  api:
    needs: setup
    runs-on: ${{ needs.setup.outputs.test_runner }}
    if: ${{ needs.setup.outputs.run_api_test == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Node.jsの構築
        uses: ./.github/actions/setup_node
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}

      - name: Supabaseのセットアップ
        uses: ./.github/actions/setup_supabase

      - name: DB Migration
        env:
          DIRECT_URL: ${{ env.DATABASE_URL }}
        run: npm run db:migrate

      - name: APIのテスト
        uses: ./.github/actions/test_cov
        with:
          target: api
