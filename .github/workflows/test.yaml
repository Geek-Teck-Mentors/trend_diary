name: Test

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/test.yaml'
      - 'application/src/**'
      - 'application/package.json'
      - 'application/package-lock.json'
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/test.yaml'
      - 'application/src/**'
      - 'application/package.json'
      - 'application/package-lock.json'

# カバレッジの可視化で、コメントを残すための権限
permissions:
  contents: read
  pull-requests: write

# 共通の設定を定義
env:
  NODE_VERSION_FILE: .node-version

defaults:
  run:
    shell: bash
    working-directory: ./application

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      test_runner: ubuntu-latest
      run_client_test: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' || steps.check-test-config.outputs.diff-count != 0 || steps.check-client.outputs.diff-count != 0 }}
      run_domain_test: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' || steps.check-test-config.outputs.diff-count != 0 || steps.check-domain.outputs.diff-count != 0 }}
      run_server_test: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' || steps.check-test-config.outputs.diff-count != 0 || steps.check-server.outputs.diff-count != 0 }}
      run_common_test: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' || steps.check-test-config.outputs.diff-count != 0 || steps.check-common.outputs.diff-count != 0 }}
    steps:
      - uses: actions/checkout@v4

      - name: テスト設定ファイルの差分チェック
        id: check-test-config
        uses: ./.github/actions/diff
        with:
          subdir: '.github/workflows/test.yaml application/src/test/vitest/'

      - name: クライアントの差分チェック
        id: check-client
        uses: ./.github/actions/diff
        with:
          subdir: 'application/src/web/client'
          exclude_pattern: 'application/src/web/client/components/shadcn'

      - name: ドメインの差分チェック
        id: check-domain
        uses: ./.github/actions/diff
        with:
          subdir: 'application/src/domain'

      - name: サーバーの差分チェック
        id: check-server
        uses: ./.github/actions/diff
        with:
          subdir: 'application/src/web/server'

      - name: 共通モジュールの差分チェック
        id: check-common
        uses: ./.github/actions/diff
        with:
          subdir: 'application/src/common'

      - name: 差分結果の表示
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "メインブランチなので、リグレッションテストとして全て実行"
          else
            echo "テスト設定差分: ${{ steps.check-test-config.outputs.diff-count }} ファイル"
            echo "クライアント差分: ${{ steps.check-client.outputs.diff-count }} ファイル"
            echo "ドメイン差分: ${{ steps.check-domain.outputs.diff-count }} ファイル"
            echo "サーバー差分: ${{ steps.check-server.outputs.diff-count }} ファイル"
            if [[ "${{ steps.check-test-config.outputs.diff-count }}" != "0" ]]; then
              echo "テスト設定ファイルに変更があるため、全テストを実行"
            fi
            echo "テストの準備完了"
          fi
        shell: bash

  client:
    needs: setup
    runs-on: ${{ needs.setup.outputs.test_runner }}
    if: ${{ needs.setup.outputs.run_client_test == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Node.jsの構築
        uses: ./.github/actions/setup_node
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}

      - name: クライアントのテスト
        uses: ./.github/actions/test_cov
        with:
          target: client

  domain:
    needs: setup
    runs-on: ${{ needs.setup.outputs.test_runner }}
    if: ${{ needs.setup.outputs.run_domain_test == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Node.jsの構築
        uses: ./.github/actions/setup_node
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}

      - name: ドメインのテスト
        uses: ./.github/actions/test_cov
        with:
          target: domain

  server:
    needs: setup
    runs-on: ${{ needs.setup.outputs.test_runner }}
    if: ${{ needs.setup.outputs.run_server_test == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Node.jsの構築
        uses: ./.github/actions/setup_node
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}

      - name: Supabaseのセットアップ
        uses: ./.github/actions/setup_supabase

      - name: DB Migration
        env:
          DIRECT_URL: ${{ env.DATABASE_URL }}
        run: npm run db:migrate

      - name: サーバーのテスト
        uses: ./.github/actions/test_cov
        with:
          target: server

  common:
    needs: setup
    runs-on: ${{ needs.setup.outputs.test_runner }}
    if: ${{ needs.setup.outputs.run_common_test == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Node.jsの構築
        uses: ./.github/actions/setup_node
        with:
          node-version-file: ${{ env.NODE_VERSION_FILE }}
      
      - name: 共通モジュールのテスト
        uses: ./.github/actions/test_cov
        with:
          target: common